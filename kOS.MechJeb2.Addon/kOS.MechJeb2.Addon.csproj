<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <Import Project="..\packages\KSPBuildTools.0.0.5\build\KSPBuildTools.props" Condition="Exists('..\packages\KSPBuildTools.0.0.5\build\KSPBuildTools.props')"/>
    <Import Project="..\packages\JsonPoke.1.2.0\build\JsonPoke.props" Condition="Exists('..\packages\JsonPoke.1.2.0\build\JsonPoke.props')"/>
    <Import Project="$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props" Condition="Exists('$(MSBuildExtensionsPath)\$(MSBuildToolsVersion)\Microsoft.Common.props')"/>
    <PropertyGroup>
        <Configuration Condition=" '$(Configuration)' == '' ">Debug</Configuration>
        <Platform Condition=" '$(Platform)' == '' ">AnyCPU</Platform>
        <ProjectGuid>{5BE4D793-8C92-424E-BC9B-200FC9EBC4F4}</ProjectGuid>
        <OutputType>Library</OutputType>
        <AppDesignerFolder>Properties</AppDesignerFolder>
        <RootNamespace>kOS.MechJeb2.Addon</RootNamespace>
        <AssemblyName>kOS.MechJeb2.Addon</AssemblyName>
        <TargetFrameworkVersion>v4.8</TargetFrameworkVersion>
        <FileAlignment>512</FileAlignment>
        <LangVersion>default</LangVersion>
    </PropertyGroup>
    <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Debug|AnyCPU' ">
        <PlatformTarget>AnyCPU</PlatformTarget>
        <DebugSymbols>true</DebugSymbols>
        <DebugType>full</DebugType>
        <Optimize>false</Optimize>
        <OutputPath>bin\Debug\</OutputPath>
        <DefineConstants>DEBUG;TRACE</DefineConstants>
        <ErrorReport>prompt</ErrorReport>
        <WarningLevel>4</WarningLevel>
    </PropertyGroup>
    <PropertyGroup Condition=" '$(Configuration)|$(Platform)' == 'Release|AnyCPU' ">
        <PlatformTarget>AnyCPU</PlatformTarget>
        <DebugType>none</DebugType>
        <Optimize>true</Optimize>
        <OutputPath>bin\Release\</OutputPath>
        <DefineConstants>TRACE</DefineConstants>
        <ErrorReport>prompt</ErrorReport>
        <WarningLevel>4</WarningLevel>
    </PropertyGroup>
    <ItemGroup>
        <Reference Include="kOS">
            <HintPath>..\References\kOS.dll</HintPath>
            <Private>False</Private>
        </Reference>
        <Reference Include="kOS.Safe, Culture=neutral, PublicKeyToken=null">
            <HintPath>..\References\kOS.Safe.dll</HintPath>
            <Private>False</Private>
            <SpecificVersion>False</SpecificVersion>
        </Reference>
    </ItemGroup>
    <ItemGroup>
        <Compile Include="Addon.cs"/>
        <Compile Include="Attributes\ComputedModuleAttribute.cs"/>
        <Compile Include="Attributes\MechJebStaticMethodInfoAttribute.cs" />
        <Compile Include="Attributes\MechJebTypeNameAttribute.cs"/>
        <Compile Include="Core\Constants.cs"/>
        <Compile Include="Core\IBaseWrapper.cs"/>
        <Compile Include="Core\IInfoItemsWrapper.cs"/>
        <Compile Include="Core\IMechJebAscentWrapper.cs"/>
        <Compile Include="Core\IMechJebCoreWrapper.cs"/>
        <Compile Include="Core\IOrbitalManeuverCalculator.cs" />
        <Compile Include="Core\IVesselStateWrapper.cs"/>
        <Compile Include="Helpers\OrbitalCalculatorHelper.cs" />
        <Compile Include="KOSextensions\FourArgsSuffix.cs" />
        <Compile Include="kOS\PredicatedSetSuffix.cs"/>
        <Compile Include="MechJebController.cs"/>
        <Compile Include="Properties\AssemblyInfo.cs"/>
        <Compile Include="Utils\GlobalMethodCache.cs" />
        <Compile Include="Utils\FluentReflectUtils.cs"/>
        <Compile Include="Utils\MechJebBinder.cs"/>
        <Compile Include="Utils\ReflectionUtils.cs"/>
        <Compile Include="Utils\VesselUtils.cs"/>
        <Compile Include="Wrapeers\BaseWrapper.cs"/>
        <Compile Include="Wrapeers\MechJebAscentWrapper.cs"/>
        <Compile Include="Wrapeers\MechJebCoreWrapper.cs"/>
        <Compile Include="Wrapeers\MechJebInfoItemsWrapper.cs"/>
        <Compile Include="Wrapeers\VesselStateWrapper.cs"/>
    </ItemGroup>
    <ItemGroup>
        <None Include="packages.config"/>
    </ItemGroup>
    <!-- Version Files -->
    <!--    <ItemGroup>-->
    <!--        <KSPVersionFile Include=".">-->
    <!--            <Destination>$(RepoRootPath)GameData/kOS.MechJeb2.Addon/kOS.MechJeb2.Addon.version</Destination>-->
    <!--            <URL>https://github.com/belpyro/kOS.MechJeb2.Addon/releases/latest/download/kOS.MechJeb2.Addon.version</URL>-->
    <!--            <Download>https://github.com/belpyro/kOS.MechJeb2.Addon/releases/latest</Download>-->
    <!--            <Version>$(ModVersion)</Version>-->
    <!--        </KSPVersionFile>-->
    <!--    </ItemGroup>-->
    <ItemGroup>
        <ReferencePathWithRefAssemblies Update="\Users\belpyro\Library\Application Support\Steam\steamapps\common\Kerbal Space Program\KSP.app\Contents\Resources\Data\Managed\System.Core.dll"/>
    </ItemGroup>
    <Import Project="$(MSBuildToolsPath)\Microsoft.CSharp.targets"/>
    <Target Name="EnsureNuGetPackageBuildImports" BeforeTargets="PrepareForBuild">
        <PropertyGroup>
            <ErrorText>This project references NuGet package(s) that are missing on this computer. Enable NuGet Package Restore to download them. For more information, see http://go.microsoft.com/fwlink/?LinkID=322105.The missing file is {0}.</ErrorText>
        </PropertyGroup>
        <Error Condition="!Exists('..\packages\JsonPoke.1.2.0\build\JsonPoke.props')" Text="$([System.String]::Format('$(ErrorText)', '..\packages\JsonPoke.1.2.0\build\JsonPoke.props'))"/>
        <Error Condition="!Exists('..\packages\JsonPoke.1.2.0\build\JsonPoke.targets')" Text="$([System.String]::Format('$(ErrorText)', '..\packages\JsonPoke.1.2.0\build\JsonPoke.targets'))"/>
        <Error Condition="!Exists('..\packages\KSPBuildTools.0.0.5\build\KSPBuildTools.props')" Text="$([System.String]::Format('$(ErrorText)', '..\packages\KSPBuildTools.0.0.5\build\KSPBuildTools.props'))"/>
        <Error Condition="!Exists('..\packages\KSPBuildTools.0.0.5\build\KSPBuildTools.targets')" Text="$([System.String]::Format('$(ErrorText)', '..\packages\KSPBuildTools.0.0.5\build\KSPBuildTools.targets'))"/>
    </Target>
    <Import Project="..\packages\JsonPoke.1.2.0\build\JsonPoke.targets" Condition="Exists('..\packages\JsonPoke.1.2.0\build\JsonPoke.targets')"/>
    <Import Project="..\packages\KSPBuildTools.0.0.5\build\KSPBuildTools.targets" Condition="Exists('..\packages\KSPBuildTools.0.0.5\build\KSPBuildTools.targets')"/>
    <PropertyGroup>
        <ModVersion>0.0.1</ModVersion>
    </PropertyGroup>
    <Target Name="ResolveVersionFromGit" BeforeTargets="Build">
        <Exec Command="git describe --tags --abbrev=0 --match &quot;v[0-9]*&quot;"
              ConsoleToMsBuild="true"
              IgnoreExitCode="true">
            <Output TaskParameter="ConsoleOutput" PropertyName="GitTagRaw"/>
            <Output TaskParameter="ExitCode" PropertyName="GitDescribeExitCode"/>
        </Exec>
        <PropertyGroup Condition="'$(GitDescribeExitCode)' == '0'">
            <GitTagTrimmed>$([System.String]::Copy('$(GitTagRaw)').Trim())</GitTagTrimmed>
            <GitTagNoPrefix>$([System.Text.RegularExpressions.Regex]::Replace('$(GitTagTrimmed)', '^v', ''))</GitTagNoPrefix>
            <ModVersion>$(GitTagNoPrefix)</ModVersion>
        </PropertyGroup>
        <PropertyGroup>
            <FileVersion>$(ModVersion)</FileVersion>
            <AssemblyVersion>$(ModVersion)</AssemblyVersion>
            <InformationalVersion>$(ModVersion)</InformationalVersion>
        </PropertyGroup>
        <Message Importance="High" Text="Resolved ModVersion = $(ModVersion)"/>
    </Target>
    <PropertyGroup>
        <GeneratedVersionInfo>$(IntermediateOutputPath)GeneratedVersionInfo.cs</GeneratedVersionInfo>
    </PropertyGroup>
    <Target Name="GenerateVersionInfo"
            BeforeTargets="CoreCompile"
            DependsOnTargets="ResolveVersionFromGit">
        <PropertyGroup>
            <ModMajor>$([System.Text.RegularExpressions.Regex]::Replace('$(ModVersion)', '^([0-9]+)\..*$', '$1'))</ModMajor>
            <ModMinor>$([System.Text.RegularExpressions.Regex]::Replace('$(ModVersion)', '^[0-9]+\.([0-9]+).*$', '$1'))</ModMinor>
            <ModPatch>$([System.Text.RegularExpressions.Regex]::Replace('$(ModVersion)', '^[0-9]+\.[0-9]+\.([0-9]+).*$', '$1'))</ModPatch>
        </PropertyGroup>
        <ItemGroup>
            <VersionInfoLines Include="[assembly: System.Reflection.AssemblyVersion(&quot;$(ModVersion)&quot;)]"/>
            <VersionInfoLines Include="[assembly: System.Reflection.AssemblyFileVersion(&quot;$(ModVersion)&quot;)]"/>
            <VersionInfoLines Include="[assembly: System.Reflection.AssemblyInformationalVersion(&quot;$(ModVersion)&quot;)]"/>
            <VersionInfoLines Include="[assembly: KSPAssembly(&quot;kOS.MechJeb2.Addon&quot;, $(ModMajor), $(ModMinor), $(ModPatch))]"/>
        </ItemGroup>
        <WriteLinesToFile
                File="$(GeneratedVersionInfo)"
                Overwrite="true"
                Lines="@(VersionInfoLines)"/>
        <ItemGroup>
            <Compile Include="$(GeneratedVersionInfo)"/>
        </ItemGroup>
        <Message Importance="High"
                 Text="Generated version info: $(GeneratedVersionInfo) = $(ModVersion) (KSPAssembly $(ModMajor).$(ModMinor).$(ModPatch))"/>
    </Target>
    <Target Name="SetupKSPVersionFile"
            DependsOnTargets="ResolveVersionFromGit"
            BeforeTargets="GenerateKSPVersionFile">
        <ItemGroup>
            <KSPVersionFile Include="kOS.MechJeb2.Addon.version">
                <Destination>$(RepoRootPath)GameData/kOS.MechJeb2.Addon/kOS.MechJeb2.Addon.version</Destination>
                <URL>https://github.com/belpyro/kOS.MechJeb2.Addon/releases/latest/download/kOS.MechJeb2.Addon.version</URL>
                <Download>https://github.com/belpyro/kOS.MechJeb2.Addon/releases/latest</Download>
                <Version>$(ModVersion)</Version>
            </KSPVersionFile>
        </ItemGroup>
    </Target>
    <Target Name="PackAndDeploy" AfterTargets="Build">
        <GetAssemblyIdentity AssemblyFiles="$(TargetPath)">
            <Output TaskParameter="Assemblies" ItemName="BuiltAssembly"/>
        </GetAssemblyIdentity>
        <PropertyGroup>
            <OutputDir>$(MSBuildProjectDirectory)/../Build</OutputDir>
            <ZipName>kOS.MechJeb2.Addon-v$(ModVersion).zip</ZipName>
            <ModRoot>$(MSBuildProjectDirectory)/../GameData/kOS.MechJeb2.Addon</ModRoot>
            <DeployDir>$(KSPRoot)/GameData/kOS.MechJeb2.Addon</DeployDir>
            <RepoModPath>$(RepoRootPath)/$(BinariesOutputRelativePath)</RepoModPath>
            <KSPModPath>$(KSPRoot)/$(BinariesOutputRelativePath)</KSPModPath>
        </PropertyGroup>
        <MakeDir Directories="$(OutputDir)" Condition="!Exists('$(OutputDir)')"/>
        <Exec WorkingDirectory="$(RepoRootPath)"
              Command="zip '$(OutputDir)/$(ZipName)' 'GameData/kOS.MechJeb2.Addon/kOS.MechJeb2.Addon.dll' 'GameData/kOS.MechJeb2.Addon/kOS.MechJeb2.Addon.version'" />
        <ItemGroup Condition=" '$(KSPRoot)' != '' ">
            <ModFiles Include="$(RepoModPath)/**/*"/>
        </ItemGroup>
        <RemoveDir Directories="$(KSPModPath)" Condition=" '$(KSPRoot)' != '' AND Exists('$(KSPModPath)')"/>
        <MakeDir Directories="$(KSPModPath)" Condition=" '$(KSPRoot)' != '' "/>
        <Copy
                Condition=" '$(KSPRoot)' != '' "
                SourceFiles="@(ModFiles)"
                DestinationFiles="@(ModFiles->'$(KSPModPath)/%(RecursiveDir)%(Filename)%(Extension)')"/>
    </Target>
</Project>
